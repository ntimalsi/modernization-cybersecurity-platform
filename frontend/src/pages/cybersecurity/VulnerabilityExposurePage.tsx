import * as React from "react";

type Finding = {
  id: string;
  asset: string;
  owner: string;
  category: "open_port" | "cve" | "misconfig" | "weak_auth";
  severity: "critical" | "high" | "medium" | "low";
  summary: string;
  evidence: string;
  detectedAt: string;
  status: "open" | "in_progress" | "mitigated";
};

const mockFindings: Finding[] = [
  {
    id: "f-1",
    asset: "Legacy Windows Server 2012",
    owner: "Facilities IT",
    category: "cve",
    severity: "critical",
    summary: "Multiple critical vulnerabilities detected on unsupported OS",
    evidence: "OS: Windows Server 2012, patch baseline missing",
    detectedAt: "2025-12-18",
    status: "open"
  },
  {
    id: "f-2",
    asset: "API Server Cluster",
    owner: "Platform Team",
    category: "open_port",
    severity: "high",
    summary: "Admin port exposed beyond expected segment",
    evidence: "Port 8443 reachable from non-admin network (demo)",
    detectedAt: "2025-12-19",
    status: "in_progress"
  },
  {
    id: "f-3",
    asset: "Student Services App",
    owner: "App Team",
    category: "misconfig",
    severity: "medium",
    summary: "Logging level set to DEBUG in production config",
    evidence: "Config drift indicated logLevel=debug",
    detectedAt: "2025-12-17",
    status: "mitigated"
  },
  {
    id: "f-4",
    asset: "SSO / IdP",
    owner: "IAM",
    category: "weak_auth",
    severity: "high",
    summary: "Privileged accounts without MFA coverage above threshold",
    evidence: "MFA coverage below 90% for privileged group (demo)",
    detectedAt: "2025-12-10",
    status: "open"
  }
];

function Card({ title, subtitle, children }: { title: string; subtitle?: string; children: React.ReactNode }) {
  return (
    <div style={{ border: "1px solid #e5e7eb", borderRadius: 16, background: "white", padding: 16 }}>
      <div style={{ fontSize: 16, fontWeight: 900 }}>{title}</div>
      {subtitle && <div style={{ color: "#6b7280", marginTop: 6 }}>{subtitle}</div>}
      <div style={{ marginTop: 14 }}>{children}</div>
    </div>
  );
}

function KPI({ label, value }: { label: string; value: string }) {
  return (
    <div style={{ border: "1px solid #e5e7eb", borderRadius: 16, padding: 12, background: "white" }}>
      <div style={{ color: "#6b7280", fontSize: 12, fontWeight: 800 }}>{label}</div>
      <div style={{ marginTop: 6, fontSize: 22, fontWeight: 900 }}>{value}</div>
    </div>
  );
}

function sevColor(sev: Finding["severity"]) {
  if (sev === "critical") return "#dc2626";
  if (sev === "high") return "#d97706";
  if (sev === "medium") return "#2563eb";
  return "#6b7280";
}

function pill(text: string, color: string) {
  return (
    <span style={{ display: "inline-flex", padding: "2px 10px", borderRadius: 999, border: "1px solid #e5e7eb", fontWeight: 900, fontSize: 12, color }}>
      {text}
    </span>
  );
}

export default function VulnerabilityExposurePage() {
  const [owner, setOwner] = React.useState("all");
  const [status, setStatus] = React.useState<Finding["status"] | "all">("open");
  const [severity, setSeverity] = React.useState<Finding["severity"] | "all">("all");

  const owners = React.useMemo(() => Array.from(new Set(mockFindings.map((x) => x.owner))), []);

  const rows = mockFindings.filter((x) => {
    const okOwner = owner === "all" ? true : x.owner === owner;
    const okStatus = status === "all" ? true : x.status === status;
    const okSev = severity === "all" ? true : x.severity === severity;
    return okOwner && okStatus && okSev;
  });

  const openCount = mockFindings.filter((x) => x.status === "open").length;
  const criticalOpen = mockFindings.filter((x) => x.status !== "mitigated" && x.severity === "critical").length;
  const highOpen = mockFindings.filter((x) => x.status !== "mitigated" && x.severity === "high").length;

  return (
    <div style={{ display: "grid", gap: 12 }}>
      <Card
        title="Vulnerability & Exposure"
        subtitle="Exposure posture across assets: open services, CVEs, misconfigurations, and weak authentication signals. Prioritize what is exploitable and high impact."
      >
        <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 12 }}>
          <KPI label="Open findings" value={String(openCount)} />
          <KPI label="Critical (not mitigated)" value={String(criticalOpen)} />
          <KPI label="High (not mitigated)" value={String(highOpen)} />
          <KPI label="Total tracked" value={String(mockFindings.length)} />
        </div>

        <div style={{ display: "flex", gap: 10, flexWrap: "wrap", marginTop: 14 }}>
          <select value={owner} onChange={(e) => setOwner(e.target.value)} style={{ padding: 10, borderRadius: 12, border: "1px solid #e5e7eb" }}>
            <option value="all">All owners</option>
            {owners.map((o) => (
              <option key={o} value={o}>
                {o}
              </option>
            ))}
          </select>

          <select value={status} onChange={(e) => setStatus(e.target.value as any)} style={{ padding: 10, borderRadius: 12, border: "1px solid #e5e7eb" }}>
            <option value="all">All statuses</option>
            <option value="open">Open</option>
            <option value="in_progress">In progress</option>
            <option value="mitigated">Mitigated</option>
          </select>

          <select value={severity} onChange={(e) => setSeverity(e.target.value as any)} style={{ padding: 10, borderRadius: 12, border: "1px solid #e5e7eb" }}>
            <option value="all">All severities</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>

          <button
            style={{ marginLeft: "auto", padding: "10px 12px", borderRadius: 14, border: "1px solid #e5e7eb", background: "#111827", color: "white", fontWeight: 900, cursor: "pointer" }}
            onClick={() => alert("Demo: convert top findings to a remediation backlog and assign owners (coming next).")}
          >
            Generate Remediation Backlog (Demo)
          </button>
        </div>

        <div style={{ marginTop: 14, overflowX: "auto" }}>
          <table style={{ width: "100%", borderCollapse: "collapse" }}>
            <thead>
              <tr>
                <th style={{ textAlign: "left", borderBottom: "1px solid #eee", padding: 8 }}>Asset</th>
                <th style={{ textAlign: "left", borderBottom: "1px solid #eee", padding: 8 }}>Owner</th>
                <th style={{ textAlign: "left", borderBottom: "1px solid #eee", padding: 8 }}>Category</th>
                <th style={{ textAlign: "left", borderBottom: "1px solid #eee", padding: 8 }}>Severity</th>
                <th style={{ textAlign: "left", borderBottom: "1px solid #eee", padding: 8 }}>Summary</th>
                <th style={{ textAlign: "left", borderBottom: "1px solid #eee", padding: 8 }}>Status</th>
                <th style={{ textAlign: "left", borderBottom: "1px solid #eee", padding: 8 }}>Detected</th>
                <th style={{ textAlign: "left", borderBottom: "1px solid #eee", padding: 8 }}>Action</th>
              </tr>
            </thead>
            <tbody>
              {rows.map((x) => (
                <tr key={x.id}>
                  <td style={{ borderBottom: "1px solid #f3f3f3", padding: 8, fontWeight: 900 }}>{x.asset}</td>
                  <td style={{ borderBottom: "1px solid #f3f3f3", padding: 8 }}>{x.owner}</td>
                  <td style={{ borderBottom: "1px solid #f3f3f3", padding: 8, color: "#6b7280" }}>{x.category}</td>
                  <td style={{ borderBottom: "1px solid #f3f3f3", padding: 8 }}>{pill(x.severity.toUpperCase(), sevColor(x.severity))}</td>
                  <td style={{ borderBottom: "1px solid #f3f3f3", padding: 8 }}>
                    <div style={{ fontWeight: 800 }}>{x.summary}</div>
                    <div style={{ color: "#6b7280", fontSize: 12, marginTop: 4 }}>{x.evidence}</div>
                  </td>
                  <td style={{ borderBottom: "1px solid #f3f3f3", padding: 8 }}>{x.status}</td>
                  <td style={{ borderBottom: "1px solid #f3f3f3", padding: 8 }}>{x.detectedAt}</td>
                  <td style={{ borderBottom: "1px solid #f3f3f3", padding: 8 }}>
                    <button
                      style={{ padding: "8px 10px", borderRadius: 12, border: "1px solid #e5e7eb", cursor: "pointer", fontWeight: 900 }}
                      onClick={() => alert("Demo: open finding details + evidence + recommended fix (coming next).")}
                    >
                      View
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <div style={{ marginTop: 14, border: "1px solid #e5e7eb", borderRadius: 16, padding: 12, background: "#fafafa" }}>
          <div style={{ fontWeight: 900 }}>Recommended Actions (demo)</div>
          <ul style={{ marginTop: 8, paddingLeft: 18 }}>
            <li>Prioritize exploitable high-impact findings (critical CVEs + exposed admin ports).</li>
            <li>Use golden baselines + policy-as-code to prevent recurring misconfigs.</li>
            <li>Track remediation SLAs by severity and ownership to reduce backlog growth.</li>
          </ul>
        </div>
      </Card>
    </div>
  );
}
